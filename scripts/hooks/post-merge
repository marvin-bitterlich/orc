#!/bin/bash

# =============================================================================
# Post-merge hook - Reminder for AI agents
# Shows breadcrumbs about post-merge tasks
# =============================================================================

BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo ""
echo "ðŸ“ Merged into: $BRANCH"

# Remind about schema sync
if command -v atlas &>/dev/null; then
    if atlas schema diff --env local 2>/dev/null | grep -q .; then
        echo "âš ï¸  Schema may differ from schema.sql"
        echo "   Run: make schema-diff   (preview)"
        echo "   Run: make schema-apply  (apply changes)"
    else
        echo "âœ“ Schema appears in sync"
    fi
else
    echo "ðŸ’¡ Atlas not installed - run: brew install ariga/tap/atlas"
fi

# Master/main branch reminders
if [[ "$BRANCH" == "master" || "$BRANCH" == "main" ]]; then
    echo ""
    echo "ðŸ“‹ Master branch checklist:"
    echo "   [ ] make init          # Initialize dependencies"
    echo "   [ ] make install       # Install orc binary"
    echo "   [ ] make deploy-glue   # Deploy Claude Code glue"
    echo "   [ ] make test          # Verify tests pass"

    # Environment health check
    if command -v orc &>/dev/null; then
        echo ""
        echo "ðŸ¥ Running environment health check..."
        if orc doctor --quiet; then
            echo "âœ“ Environment healthy"
        else
            echo "âš ï¸  Environment issues detected - run: orc doctor"
        fi
    fi

    # Release hints
    if [[ -f "VERSION" ]]; then
        VERSION=$(cat VERSION)
        TAG="v$VERSION"
        if git rev-parse "$TAG" &>/dev/null; then
            COMMITS=$(git rev-list "$TAG"..HEAD --count)
            if [[ "$COMMITS" -gt 0 ]]; then
                TAG_DATE=$(git log -1 --format=%ct "$TAG")
                NOW=$(date +%s)
                DAYS=$(( (NOW - TAG_DATE) / 86400 ))
                echo ""
                echo "ðŸ“¦ $COMMITS commits since $TAG ($DAYS days ago)"
                echo "   Run /release to cut a new version"
            fi
        else
            echo ""
            echo "ðŸ“¦ No release tag found. Run /release to create first release."
        fi
    fi
fi
echo ""
