# Commission Provisioning Finite State Machine
# Single source of truth for commission lifecycle in ORC
#
# Generated: 2026-01-19
# Context: CON-003 FSM-First Testing Strategy

name: commission-provisioning
version: "1.0"
description: |
  Defines the complete lifecycle of a Commission entity in ORC.
  Commissions are the top-level coordination scope for work.

# =============================================================================
# STATES
# =============================================================================
states:
  initial:
    description: No commission exists yet (pre-creation)
    terminal: false

  active:
    description: Commission is created and available for work
    terminal: false
    invariants:
      - status == "active"
      - created_at is set
      - updated_at >= created_at

  paused:
    description: Commission is temporarily suspended (defined but rarely used)
    terminal: false
    invariants:
      - status == "paused"
      - previous_status == "active"

  complete:
    description: Commission work is finished, completed_at is set
    terminal: false  # Can still archive
    invariants:
      - status == "complete"
      - completed_at is set
      - not pinned  # Invariant: completed commissions cannot be pinned

  archived:
    description: Commission is historical record, no longer active
    terminal: true  # Terminal for normal operations (delete still possible)
    invariants:
      - status == "archived"
      - not pinned  # Invariant: archived commissions cannot be pinned

  deleted:
    description: Commission removed from database (true terminal state)
    terminal: true

# =============================================================================
# EVENTS
# =============================================================================
events:
  create:
    description: Create a new commission with title and optional description
    payload:
      title: { type: string, required: true }
      description: { type: string, required: false }

  update:
    description: Update commission title and/or description
    payload:
      title: { type: string, required: false }
      description: { type: string, required: false }

  start:
    description: Legacy command - create workspace and TMux session
    payload:
      workspace_path: { type: string, required: false, default: "~/src/commissions/{COMM_ID}" }

  launch:
    description: Plan/apply pattern for infrastructure provisioning (idempotent)
    payload:
      workspace_path: { type: string, required: false }
      create_tmux: { type: boolean, required: false, default: false }

  complete:
    description: Mark commission as finished
    payload: {}

  archive:
    description: Archive commission for historical record
    payload: {}

  pin:
    description: Pin commission to prevent completion/archiving
    payload: {}

  unpin:
    description: Unpin commission to allow completion/archiving
    payload: {}

  delete:
    description: Remove commission from database
    payload:
      force: { type: boolean, required: false, default: false }

# =============================================================================
# TRANSITIONS
# =============================================================================
transitions:
  # --- Creation ---
  - name: create_commission
    from: initial
    to: active
    event: create
    guards:
      - is_orc  # Only ORC can create commissions
    effects:
      - { type: WriteDB, operation: INSERT, table: commissions }
    test_cases:
      - "ORC creates commission with title only"
      - "ORC creates commission with title and description"
      - "IMP blocked from creating commission"

  # --- Updates (while active) ---
  - name: update_commission
    from: active
    to: active
    event: update
    guards: []
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [title, description, updated_at] }
    test_cases:
      - "Update title only"
      - "Update description only"
      - "Update both title and description"
      - "Update with empty values (no-op)"

  # --- Infrastructure Provisioning ---
  - name: start_commission
    from: active
    to: active
    event: start
    guards:
      - is_orc
      - not_in_orc_source
    effects:
      - { type: CreateWorkspace, path: "{workspace_path}" }
      - { type: WriteConfig, path: "{workspace_path}/.orc/config.json", config_type: commission }
      - { type: SpawnTmux, session: "orc-{COMM_ID}" }
    test_cases:
      - "ORC starts commission, creates workspace"
      - "ORC starts commission with custom workspace path"
      - "IMP blocked from starting commission"
      - "Start from ORC source directory blocked"
      - "Start with existing TMux session (error)"

  - name: launch_commission
    from: active
    to: active
    event: launch
    guards:
      - is_orc
      - not_in_orc_source
    effects:
      - { type: CreateWorkspace, path: "{workspace_path}" }
      - { type: CreateWorkspace, path: "{workspace_path}/workbenches" }
      - { type: WriteConfig, path: "{workbench_path}/.orc/config.json", config_type: workbench, foreach: workbenches }
      - { type: WriteConfig, path: "{workbench_path}/.claude/settings.local.json", foreach: workbenches }
      - { type: UpdateDB, operation: UPDATE, table: workbenches, fields: [path], condition: "path changed" }
      - { type: SpawnTmux, session: "orc-{COMM_ID}", conditional: "create_tmux == true" }
    test_cases:
      - "Launch creates workspace and workbenches directory"
      - "Launch moves workbenches to standard location"
      - "Launch writes workbench configs"
      - "Launch with --tmux creates session"
      - "Launch without --tmux skips TMux"
      - "Launch is idempotent (run twice, same result)"
      - "IMP blocked from launching commission"

  # --- Pinning ---
  - name: pin_commission
    from: active
    to: active
    event: pin
    guards:
      - exists  # Commission must exist
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [pinned, updated_at], values: [1] }
    test_cases:
      - "Pin active commission"
      - "Pin already-pinned commission (no-op)"
      - "Pin non-existent commission (error)"

  - name: unpin_commission
    from: active
    to: active
    event: unpin
    guards:
      - exists
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [pinned, updated_at], values: [0] }
    test_cases:
      - "Unpin pinned commission"
      - "Unpin unpinned commission (no-op)"

  # --- Completion ---
  - name: complete_commission
    from: active
    to: complete
    event: complete
    guards:
      - not_pinned  # Cannot complete pinned commission
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [status, completed_at, updated_at] }
    test_cases:
      - "Complete unpinned commission"
      - "Complete pinned commission (error with helpful message)"
      - "Complete already-complete commission (no-op or error)"

  # --- Archiving ---
  - name: archive_active_commission
    from: active
    to: archived
    event: archive
    guards:
      - not_pinned
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [status, updated_at] }
    test_cases:
      - "Archive active unpinned commission"
      - "Archive pinned commission (error)"

  - name: archive_complete_commission
    from: complete
    to: archived
    event: archive
    guards:
      - not_pinned  # Should already be unpinned, but defensive
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [status, updated_at] }
    test_cases:
      - "Archive completed commission"

  # --- Pausing (rarely used) ---
  - name: pause_commission
    from: active
    to: paused
    event: update
    guards:
      - status_change_to_paused  # Explicit status in update
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [status, updated_at] }
    test_cases:
      - "Pause active commission"

  - name: resume_commission
    from: paused
    to: active
    event: update
    guards:
      - status_change_to_active
    effects:
      - { type: WriteDB, operation: UPDATE, table: commissions, fields: [status, updated_at] }
    test_cases:
      - "Resume paused commission"

  # --- Deletion ---
  - name: delete_active_commission
    from: active
    to: deleted
    event: delete
    guards:
      - no_dependents_or_force  # No workbenches/shipments, or --force flag
    effects:
      - { type: WriteDB, operation: DELETE, table: commissions }
      # TODO: Cascade delete when implemented
    test_cases:
      - "Delete commission with no dependents"
      - "Delete commission with workbenches (error without --force)"
      - "Delete commission with shipments (error without --force)"
      - "Delete commission with --force (succeeds, orphans dependents)"

  - name: delete_archived_commission
    from: archived
    to: deleted
    event: delete
    guards:
      - no_dependents_or_force
    effects:
      - { type: WriteDB, operation: DELETE, table: commissions }
    test_cases:
      - "Delete archived commission"

# =============================================================================
# GUARDS
# =============================================================================
guards:
  is_orc:
    description: |
      Check that current agent is ORC (not IMP).
      IMPs are blocked from commission lifecycle operations.
    implementation: |
      identity, err := agent.GetCurrentAgentID()
      return err != nil || identity.Type != agent.AgentTypeIMP
    error_message: "IMPs cannot {action} commissions - only ORC can {action} commissions"

  not_pinned:
    description: |
      Check that commission is not pinned.
      Pinned commissions cannot be completed or archived.
    implementation: |
      commission, _ := models.GetCommission(id)
      return !commission.Pinned
    error_message: "Cannot {action} pinned commission {id}. Unpin first with: orc commission unpin {id}"

  not_in_orc_source:
    description: |
      Prevent running from ORC source directory.
      Guards against accidental modification of orchestrator.
    implementation: |
      return !context.IsOrcSourceDirectory()
    error_message: "Cannot run this command from ORC source directory"

  no_dependents_or_force:
    description: |
      Check for associated workbenches/shipments before deletion.
      Bypassed with --force flag (but orphans dependents).
    implementation: |
      if force { return true }
      workbenches, _ := models.GetWorkbenchesByCommission(id)
      shipments, _ := models.ListShipments(id, "")
      return len(workbenches) == 0 && len(shipments) == 0
    error_message: "Commission has {count} workbenches and {count} shipments. Use --force to delete anyway (will orphan dependents)"

  exists:
    description: Commission must exist in database
    implementation: |
      _, err := models.GetCommission(id)
      return err == nil
    error_message: "Commission {id} not found"

# =============================================================================
# EFFECTS
# =============================================================================
effects:
  WriteDB:
    description: Database write operation
    parameters:
      operation: { type: enum, values: [INSERT, UPDATE, DELETE] }
      table: { type: string }
      fields: { type: array, items: string, optional: true }
      condition: { type: string, optional: true }

  CreateWorkspace:
    description: Create directory structure
    parameters:
      path: { type: string }
    idempotent: true

  WriteConfig:
    description: Write JSON config file
    parameters:
      path: { type: string }
      config_type: { type: enum, values: [commission, workbench, global, claude_settings] }
    idempotent: true

  SpawnTmux:
    description: Create TMux session with windows/panes
    parameters:
      session: { type: string }
    idempotent: false  # Error if session exists

  UpdateDB:
    description: Conditional database update
    parameters:
      operation: { type: enum, values: [UPDATE] }
      table: { type: string }
      fields: { type: array, items: string }
      condition: { type: string }

# =============================================================================
# INVARIANTS
# =============================================================================
invariants:
  - name: id_format
    description: Commission IDs follow COMM-XXX format
    check: id matches /^COMM-\d{3}$/

  - name: id_unique
    description: Commission IDs are unique
    check: COUNT(SELECT id FROM commissions WHERE id = {id}) == 1

  - name: status_valid
    description: Status is one of valid values
    check: status IN ('active', 'paused', 'complete', 'archived')

  - name: pinned_blocks_terminal
    description: Pinned commissions cannot be in terminal states
    check: NOT (pinned AND status IN ('complete', 'archived'))

  - name: completed_has_timestamp
    description: Complete status requires completed_at
    check: status == 'complete' IMPLIES completed_at IS NOT NULL

  - name: timestamps_ordered
    description: Timestamps are chronologically ordered
    check: completed_at IS NULL OR completed_at >= created_at

# =============================================================================
# NOTES
# =============================================================================
notes:
  - |
    Status 'paused' is defined in schema but never used in practice.
    Only 'active' and 'archived' appear in production data.
  - |
    The 'start' and 'launch' events both provision infrastructure but
    'launch' uses plan/apply pattern and is idempotent.
  - |
    Cascade delete for dependents is marked TODO in codebase.
    Currently deletion with --force orphans related entities.
  - |
    Integration tests exist but are shell-based. This FSM should
    drive generation of Go unit tests with table-driven structure.
