# Repository Workflow Finite State Machine
# Single source of truth for repository entity lifecycle in ORC
#
# Generated: 2026-01-21
# Context: SHIP-202 Cycle 2 - REPO + PR Entities

name: repo-workflow
version: "1.0"
description: |
  Defines the complete lifecycle of a Repo entity in ORC.
  Repos are global resources representing source code repositories.
  They are referenced by PRs and workbenches for worktree creation.

# =============================================================================
# STATES
# =============================================================================
states:
  initial:
    description: No repo exists yet (pre-creation)
    terminal: false

  active:
    description: Repo is available for use
    terminal: false
    invariants:
      - status == "active"
      - created_at is set
      - name is unique

  archived:
    description: Repo is soft-deleted, not available for new PRs
    terminal: false
    invariants:
      - status == "archived"
      - no new PRs can reference this repo

  deleted:
    description: Repo removed from database (true terminal state)
    terminal: true

# =============================================================================
# EVENTS
# =============================================================================
events:
  create:
    description: Create a new repository configuration
    payload:
      name: { type: string, required: true, unique: true }
      url: { type: string, required: false }
      local_path: { type: string, required: false }
      default_branch: { type: string, required: false, default: "main" }

  update:
    description: Update repository configuration
    payload:
      url: { type: string, required: false }
      local_path: { type: string, required: false }
      default_branch: { type: string, required: false }

  archive:
    description: Archive repository (soft delete)
    payload: {}

  restore:
    description: Restore archived repository
    payload: {}

  delete:
    description: Hard-delete repository from database
    payload: {}

# =============================================================================
# TRANSITIONS
# =============================================================================
transitions:
  # --- Creation ---
  - name: create_repo
    from: initial
    to: active
    event: create
    guards:
      - name_not_empty
      - name_unique
    effects:
      - { type: WriteDB, operation: INSERT, table: repos }
    test_cases:
      - "Create repo with unique name"
      - "Create repo with empty name (error)"
      - "Create repo with duplicate name (error)"

  # --- Updating (no state change) ---
  - name: update_repo
    from: active
    to: active
    event: update
    guards: []
    effects:
      - { type: WriteDB, operation: UPDATE, table: repos, fields: [url, local_path, default_branch, updated_at] }
    test_cases:
      - "Update repo URL"
      - "Update repo local path"
      - "Update repo default branch"

  # --- Archiving ---
  - name: archive_repo
    from: active
    to: archived
    event: archive
    guards:
      - is_active
    effects:
      - { type: WriteDB, operation: UPDATE, table: repos, fields: [status, updated_at] }
    test_cases:
      - "Archive active repo"
      - "Archive archived repo (error)"

  # --- Restoring ---
  - name: restore_repo
    from: archived
    to: active
    event: restore
    guards:
      - is_archived
    effects:
      - { type: WriteDB, operation: UPDATE, table: repos, fields: [status, updated_at] }
    test_cases:
      - "Restore archived repo"
      - "Restore active repo (error)"

  # --- Deletion ---
  - name: delete_active_repo
    from: active
    to: deleted
    event: delete
    guards:
      - no_active_prs
    effects:
      - { type: WriteDB, operation: DELETE, table: repos }
    test_cases:
      - "Delete active repo with no PRs"
      - "Delete active repo with active PRs (error)"

  - name: delete_archived_repo
    from: archived
    to: deleted
    event: delete
    guards:
      - no_active_prs
    effects:
      - { type: WriteDB, operation: DELETE, table: repos }
    test_cases:
      - "Delete archived repo with no PRs"
      - "Delete archived repo with active PRs (error)"

# =============================================================================
# GUARDS
# =============================================================================
guards:
  name_not_empty:
    description: Repository name must not be empty
    implementation: |
      return len(strings.TrimSpace(name)) > 0
    error_message: "repository name cannot be empty"

  name_unique:
    description: Repository name must be unique
    implementation: |
      existing, _ := repo.GetByName(ctx, name)
      return existing == nil
    error_message: "repository with name {name} already exists"

  is_active:
    description: Repository must be in active status
    implementation: |
      repo, _ := repo.GetByID(ctx, repo_id)
      return repo.Status == "active"
    error_message: "can only archive active repositories (current status: {status})"

  is_archived:
    description: Repository must be in archived status
    implementation: |
      repo, _ := repo.GetByID(ctx, repo_id)
      return repo.Status == "archived"
    error_message: "can only restore archived repositories (current status: {status})"

  no_active_prs:
    description: No active PRs can reference this repository
    implementation: |
      has, _ := repo.HasActivePRs(ctx, repo_id)
      return !has
    error_message: "cannot delete repository with active pull requests"

# =============================================================================
# INVARIANTS
# =============================================================================
invariants:
  - name: id_format
    description: Repo IDs follow REPO-XXX format
    check: id matches /^REPO-\d{3}$/

  - name: id_unique
    description: Repo IDs are unique
    check: COUNT(SELECT id FROM repos WHERE id = {id}) == 1

  - name: name_unique
    description: Repo names are unique
    check: COUNT(SELECT name FROM repos WHERE name = {name}) == 1

  - name: status_valid
    description: Status is one of valid values
    check: status IN ('active', 'archived')

  - name: name_not_empty
    description: Repository name must not be empty
    check: LENGTH(name) > 0

# =============================================================================
# NOTES
# =============================================================================
notes:
  - |
    Repos are global resources, not scoped to commissions.
    They represent source code repositories that can be used by any mission.
  - |
    The 'archived' state allows soft-deletion while preserving
    historical references from completed PRs.
  - |
    Deletion is prevented if active PRs reference the repository
    to maintain referential integrity.
